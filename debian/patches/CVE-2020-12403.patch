From: Markus Koschany <apo@debian.org>
Date: Mon, 31 Aug 2020 12:16:28 +0200
Subject: CVE-2020-12403

This version is only partially affected.

Origin: https://hg.mozilla.org/projects/nss/rev/c25adfdfab34ddb08d3262aac3242e3399de1095
Release notes: https://developer.mozilla.org/en-US/docs/Mozilla/Projects/NSS/NSS_3.55_release_notes
---
 .../pk11_gtest/pk11_chacha20poly1305_unittest.cc      | 19 ++++++++++++++++++-
 nss/lib/freebl/chacha20poly1305.c                     |  2 +-
 2 files changed, 19 insertions(+), 2 deletions(-)

diff --git a/nss/external_tests/pk11_gtest/pk11_chacha20poly1305_unittest.cc b/nss/external_tests/pk11_gtest/pk11_chacha20poly1305_unittest.cc
index a52e317..0cec46f 100644
--- a/nss/external_tests/pk11_gtest/pk11_chacha20poly1305_unittest.cc
+++ b/nss/external_tests/pk11_gtest/pk11_chacha20poly1305_unittest.cc
@@ -131,12 +131,29 @@ class Pkcs11ChaCha20Poly1305Test : public ::testing::Test {
     SECItem params = { siBuffer, reinterpret_cast<unsigned char*>(&aead_params),
                        sizeof(aead_params) };
 
-    // Encrypt.
+    // Encrypt with bad parameters (TagLen is too long).
     unsigned int outputLen = 0;
     std::vector<uint8_t> output(data_len + aead_params.ulTagLen);
+    aead_params.ulTagLen = 158072;
     SECStatus rv = PK11_Encrypt(symKey, mech, &params, &output[0], &outputLen,
                                 output.size(), data, data_len);
+    EXPECT_EQ(rv, SECFailure);
+    EXPECT_EQ(0U, outputLen);
+
+    // Encrypt with bad parameters (TagLen is too short).
+    aead_params.ulTagLen = 2;
+    rv = PK11_Encrypt(symKey, mech, &params, &output[0],
+                      &outputLen, output.size(), data, data_len);
+    EXPECT_EQ(rv, SECFailure);
+    EXPECT_EQ(0U, outputLen);
+
+    // Encrypt.
+    aead_params.ulTagLen = 16;
+    rv = PK11_Encrypt(symKey, mech, &params, &output[0],
+                      &outputLen, output.size(), data, data_len);
+
     EXPECT_EQ(rv, SECSuccess);
+    EXPECT_EQ(output.size(), static_cast<size_t>(outputLen));
 
     // Check ciphertext and tag.
     if (ct) {
diff --git a/nss/lib/freebl/chacha20poly1305.c b/nss/lib/freebl/chacha20poly1305.c
index fb231f2..82537c8 100644
--- a/nss/lib/freebl/chacha20poly1305.c
+++ b/nss/lib/freebl/chacha20poly1305.c
@@ -70,7 +70,7 @@ ChaCha20Poly1305_InitContext(ChaCha20Poly1305Context *ctx,
         PORT_SetError(SEC_ERROR_BAD_KEY);
         return SECFailure;
     }
-    if (tagLen == 0 || tagLen > 16) {
+    if (tagLen != 16) {
         PORT_SetError(SEC_ERROR_INPUT_LEN);
         return SECFailure;
     }
